{% extends "base.html" %}
{% block title %}ChatLab{% endblock %}

{% block content %}
  <div>
    <h1 class="text-2xl font-bold">ChatLab</h1>
    <p class="text-sm text-slate-600">Testa rules por agent sem enviar para a Evolution.</p>
  </div>

  <div class="mt-6 bg-white rounded-2xl shadow-soft p-5">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div>
        <label class="text-sm text-slate-600">Instance</label>
        <select id="instance" class="mt-1 w-full h-11 rounded-2xl border border-slate-200 px-4 outline-none focus:ring-2 focus:ring-indigo-200">
          {% for i in instances %}
            <option value="{{ i }}">{{ i }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label class="text-sm text-slate-600">from_number</label>
        <input id="from_number" value="5531999999999" class="mt-1 w-full h-11 rounded-2xl border border-slate-200 px-4 outline-none focus:ring-2 focus:ring-indigo-200">
      </div>
      <div>
        <label class="text-sm text-slate-600">Mensagem</label>
        <input id="text" class="mt-1 w-full h-11 rounded-2xl border border-slate-200 px-4 outline-none focus:ring-2 focus:ring-indigo-200" placeholder="Oi">
      </div>
    </div>

    <div class="mt-4 flex gap-2">
      <button id="send" class="h-11 px-4 rounded-2xl bg-slate-900 text-white font-semibold hover:bg-slate-800">
        Enviar
      </button>
      <button id="clear" class="h-11 px-4 rounded-2xl bg-white border border-slate-200 text-slate-900 font-semibold hover:bg-slate-50">
        Limpar
      </button>
    </div>

    <div class="mt-5 grid grid-cols-1 lg:grid-cols-2 gap-4">
      <div class="rounded-2xl bg-slate-50 border border-slate-200 p-4">
        <div class="text-xs text-slate-500">Resposta</div>
        <pre id="reply" class="mt-2 text-sm whitespace-pre-wrap break-words">—</pre>
      </div>
      <div class="rounded-2xl bg-slate-50 border border-slate-200 p-4">
        <div class="text-xs text-slate-500">State</div>
        <pre id="state" class="mt-2 text-sm whitespace-pre-wrap break-words">—</pre>
      </div>
    </div>
  </div>

  <script>
    const sendUrl = "{{ send_url }}";

    function $(id){ return document.getElementById(id); }

    $("send").addEventListener("click", async () => {
      const payload = {
        instance: $("instance").value,
        from_number: $("from_number").value,
        text: $("text").value
      };

      $("reply").textContent = "enviando...";
      $("state").textContent = "aguarde...";

      try{
        const r = await fetch(sendUrl, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        const data = await r.json();
        $("reply").textContent = JSON.stringify({ok:data.ok, paused:data.paused, reply:data.reply}, null, 2);
        $("state").textContent = JSON.stringify(data.state || {}, null, 2);
      }catch(e){
        $("reply").textContent = "erro: " + e;
        $("state").textContent = "—";
      }
    });

    $("clear").addEventListener("click", () => {
      $("reply").textContent = "—";
      $("state").textContent = "—";
      $("text").value = "";
    });
  </script>
{% endblock %}
