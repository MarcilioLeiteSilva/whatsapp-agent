{% extends "base.html" %}
{% block title %}Agents{% endblock %}

{% block content %}
  <div class="flex items-start justify-between gap-4 mb-6">
    <div>
      <h1 class="text-2xl font-semibold">Agents</h1>
      <p class="text-sm text-slate-600 mt-1">Criar, listar e ajustar credenciais por agente (Opção B).</p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
    <div class="card p-4">
      <div class="text-sm font-semibold">Criar Agent</div>
      <div class="text-xs text-slate-500 mt-1">Cada agent tem instance + evolution_base_url + api_key.</div>

      <form class="mt-4 space-y-3" method="post" action="{{ create_agent_action }}">
        <div>
          <div class="label">Client</div>
          <select class="input" name="client_id" required>
            {% for c in clients %}
              <option value="{{ c.id }}">{{ c.name }} (id={{ c.id }})</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <div class="label">Nome</div>
          <input class="input" name="name" placeholder="Ex: agente001" />
        </div>

        <div>
          <div class="label">Instance (UNIQUE)</div>
          <input class="input" name="instance" placeholder="Ex: agente001" required />
        </div>

        <div>
          <div class="label">Evolution base_url</div>
          <input class="input" name="evolution_base_url" placeholder="https://evolution-dev..." />
          <div class="text-xs text-slate-500 mt-1">Se vazio, seu envio vai falhar no modo SaaS.</div>
        </div>

        <div>
          <div class="label">API Key</div>
          <input class="input" name="api_key" placeholder="token..." />
        </div>

        <div>
          <div class="label">Status</div>
          <select class="input" name="status">
            <option value="active">active</option>
            <option value="inactive">inactive</option>
          </select>
        </div>

        <button class="btn btn-primary w-full" type="submit">Criar</button>

        <div class="text-xs text-slate-500">
          Endpoint: <span class="code">{{ create_agent_action }}</span>
        </div>
      </form>
    </div>

    <div class="card p-4 lg:col-span-2">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm font-semibold">Lista de Agents</div>
          <div class="text-xs text-slate-500 mt-0.5">Total: {{ agents|length if agents else 0 }}</div>
        </div>
        <a class="btn" href="{{ url_for('admin_web_simulator') }}">Ir para Simulator</a>
      </div>

      <div class="mt-4 overflow-x-auto">
        {% if agents and agents|length > 0 %}
          <table class="table">
            <thead>
              <tr>
                <th class="th">ID</th>
                <th class="th">Client</th>
                <th class="th">Nome</th>
                <th class="th">Instance</th>
                <th class="th">Evolution</th>
                <th class="th">API Key</th>
                <th class="th">Status</th>
                <th class="th">Last seen</th>
                 <th class="th">Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for a in agents %}
                <tr>
                  <td class="td font-mono text-xs">{{ a.id }}</td>
                  <td class="td">
                    <div class="font-medium">{{ a.client_name or a.client_id }}</div>
                    <div class="text-xs text-slate-500">client_id={{ a.client_id }}</div>
                  </td>
                  <td class="td">{{ a.name or "—" }}</td>
                  <td class="td">
                    <span class="code">{{ a.instance }}</span>
                  </td>
                  <td class="td">
                    {% if a.evolution_base_url %}
                      <span class="code">{{ a.evolution_base_url }}</span>
                    {% else %}
                      <span class="badge badge-err">missing</span>
                    {% endif %}
                  </td>
                  <td class="td">
                    {% if a.api_key %}
                      <span class="badge badge-ok">set</span>
                    {% else %}
                      <span class="badge badge-err">missing</span>
                    {% endif %}
                  </td>
                  <td class="td">
                    {% set st = (a.status or "").lower() %}
                    {% if st == "active" %}
                      <span class="badge badge-ok">active</span>
                    {% elif st %}
                      <span class="badge badge-warn">{{ a.status }}</span>
                    {% else %}
                      <span class="badge badge-muted">—</span>
                    {% endif %}
                  </td>
                  <td class="td text-slate-600">{{ a.last_seen_at or "—" }}</td>
                </tr>
                <td class="text-right">
                  <a class="btn" href="{{ url_for('admin_web_agent_rules', agent_id=a.id) }}">Editar Regras</a>
                  </td>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          {% include "partials/empty.html" with context %}
        {% endif %}
      </div>

      <div class="mt-4 text-xs text-slate-500">
        Dica: o Simulator usa <span class="code">instance</span> para rotear para o agent certo.
      </div>
    </div>
  </div>
{% endblock %}
         
