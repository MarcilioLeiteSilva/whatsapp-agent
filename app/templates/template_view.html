{% extends "base.html" %}
{% block title %}Template{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">

  <!-- Header -->
  <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
    <div>
      <h1 class="text-xl md:text-2xl font-semibold text-slate-900">üîé Template: {{ template.name }}</h1>

      <div class="mt-2 flex flex-wrap gap-2">
        {% if template.niche %}
          <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2.5 py-1 text-xs text-slate-700">
            Nicho: {{ template.niche }}
          </span>
        {% endif %}
        {% if template.kind %}
          <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2.5 py-1 text-xs text-slate-700">
            Tipo: {{ template.kind }}
          </span>
        {% endif %}
        {% if template.description %}
          <span class="inline-flex items-center rounded-full border border-slate-200 bg-slate-50 px-2.5 py-1 text-xs text-slate-700">
            {{ template.description }}
          </span>
        {% endif %}
      </div>

      <p class="text-xs text-slate-500 mt-2">Atualizado: <b class="text-slate-700">{{ template.updated_at }}</b></p>
    </div>

    <div class="flex items-center gap-2">
      <a
        href="{{ back_url }}"
        class="rounded-xl px-4 py-2 text-sm font-semibold bg-white border border-slate-200 text-slate-800 hover:bg-slate-50"
      >
        ‚Üê Voltar
      </a>
      <button
        type="button"
        onclick="copyJson()"
        class="rounded-xl px-4 py-2 text-sm font-semibold bg-slate-900 text-white hover:bg-slate-800"
      >
        üìã Copiar JSON
      </button>
    </div>
  </div>

  <div class="mt-5 grid grid-cols-1 lg:grid-cols-3 gap-4">

    <!-- Apply -->
    <div class="lg:col-span-1 rounded-2xl border border-slate-200 bg-white shadow-soft">
      <div class="p-5">
        <h2 class="text-base font-semibold text-slate-900">‚úÖ Aplicar em um agente</h2>
        <p class="text-sm text-slate-500 mt-1">
          Isso vai substituir o <code class="px-1 rounded bg-slate-100 border border-slate-200">rules_json</code>
          do agente selecionado.
        </p>

        <form method="post" action="{{ apply_action }}" class="mt-4 space-y-3">
          <div>
            <label class="text-sm font-semibold text-slate-700">Agente</label>
            <select
              name="agent_id"
              required
              class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm outline-none focus:ring-2 focus:ring-indigo-200"
            >
              <option value="">-- selecione --</option>
              {% for a in agents %}
                <option value="{{ a.id }}">{{ a.name }} ({{ a.instance }})</option>
              {% endfor %}
            </select>
          </div>

          <button
            type="submit"
            class="w-full rounded-xl px-4 py-2 text-sm font-semibold bg-indigo-600 text-white hover:bg-indigo-500"
          >
            Aplicar Template
          </button>
        </form>

        <div class="mt-4 text-xs text-slate-500">
          Pr√≥ximo upgrade: aplicar e j√° abrir o editor de regras do agente.
        </div>
      </div>
    </div>

    <!-- JSON -->
    <div class="lg:col-span-2 rounded-2xl border border-slate-200 bg-white shadow-soft overflow-hidden">
      <div class="p-5 flex items-center justify-between gap-3">
        <div>
          <h2 class="text-base font-semibold text-slate-900">üìÑ Regras (JSON)</h2>
          <p class="text-sm text-slate-500 mt-1">Scroll interno ‚Ä¢ altura controlada</p>
        </div>
      </div>

      <div class="px-5 pb-5">
        <pre
          id="rulesPre"
          class="max-h-[560px] overflow-auto rounded-2xl border border-slate-200 bg-slate-950 text-slate-100 p-4 text-xs leading-relaxed font-mono"
        >{{ rules_text }}</pre>
      </div>
    </div>

  </div>

</div>

<script>
  function copyJson() {
    const text = document.getElementById('rulesPre')?.innerText || '';
    if (!text) return;
    navigator.clipboard.writeText(text).then(() => {
      alert("JSON copiado!");
    }).catch(() => {
      alert("N√£o foi poss√≠vel copiar automaticamente. Selecione e copie manualmente.");
    });
  }
</script>
{% endblock %}
